---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kube-prometheus-stack
spec:
  chart:
    spec:
      chart: kube-prometheus-stack
      reconcileStrategy: ChartVersion
      sourceRef:
        kind: HelmRepository
        name: prometheus-community
        namespace: flux-system
      version: 71.1.x
  install:
    crds: Skip
  interval: 30m0s
  upgrade:
    crds: Skip
  values:
    # from https://github.com/JefeDavis/k8s-HomeOps
    cleanPrometheusOperatorObjectNames: true

    crds:
      enabled: false # installed separately

    alertmanager:
      enabled: true
      config:
        global:
          resolve_timeout: 5m

        route:
          group_by: ['alertname', 'cluster', 'service']
          group_wait: 10s
          group_interval: 5m
          repeat_interval: 12h
          receiver: 'null'
          routes:
            # Critical alerts go to PagerDuty immediately
            - receiver: 'pagerduty-critical'
              matchers:
                - severity = "critical"
              group_wait: 10s
              group_interval: 1m
              repeat_interval: 5m
              continue: false

            # Warning alerts are batched (AlertManager UI only)
            - receiver: 'alertmanager-ui'
              matchers:
                - severity = "warning"
              group_wait: 30s
              group_interval: 5m
              repeat_interval: 12h
              continue: false

        receivers:
          # Null receiver (catches all unmatched alerts)
          - name: 'null'

          # PagerDuty for critical alerts
          - name: 'pagerduty-critical'
            pagerduty_configs:
              - routing_key: ${PAGERDUTY_INTEGRATION_KEY}
                description: '{{ .CommonAnnotations.summary }}'
                details:
                  firing: '{{ template "pagerduty.default.instances" .Alerts.Firing }}'
                  resolved: '{{ template "pagerduty.default.instances" .Alerts.Resolved }}'
                  num_firing: '{{ .Alerts.Firing | len }}'
                  num_resolved: '{{ .Alerts.Resolved | len }}'
                client: 'Homelab Kubernetes Cluster'
                client_url: 'https://grafana.${CLUSTER_DOMAIN}'
                severity: 'critical'

          # AlertManager UI only (no external notification)
          - name: 'alertmanager-ui'

        templates:
          - '/etc/alertmanager/config/*.tmpl'

    kubeApiServer:
      enabled: true
      serviceMonitor:
        metricRelabelings:
          # Drop high cardinality labels
          - action: drop
            sourceLabels: ["__name__"]
            regex: (apiserver|etcd|rest_client)_request(|_sli|_slo)_duration_seconds_bucket
          - action: drop
            sourceLabels: ["__name__"]
            regex: (apiserver_response_sizes_bucket|apiserver_watch_events_sizes_bucket)

    kubelet:
      enabled: true
      serviceMonitor:
        metricRelabelings:
          # Drop high cardinality labels
          - action: labeldrop
            regex: (uid)
          - action: labeldrop
            regex: (id|name)
          - action: drop
            sourceLabels: ["__name__"]
            regex: (rest_client_request_duration_seconds_bucket|rest_client_request_duration_seconds_sum|rest_client_request_duration_seconds_count)

    kubeProxy:
      enabled: false

    grafana:
      additionalDataSources:
        - name: Loki
          type: loki
          url: http://loki-gateway.monitoring.svc.cluster.local
          access: proxy

    prometheus:
      ingress:
        enabled: false

      prometheusSpec:
        replicas: 1
        retention: 14d
        retentionSize: 5GB
        storageSpec:
          volumeClaimTemplate:
            spec:
              storageClassName: rook-ceph-block
              resources:
                requests:
                  storage: 10Gi
        walCompression: true 

