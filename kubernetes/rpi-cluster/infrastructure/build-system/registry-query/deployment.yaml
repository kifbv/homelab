---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: registry-query
  namespace: build-system
  labels:
    app: registry-query
spec:
  replicas: 1
  selector:
    matchLabels:
      app: registry-query
  template:
    metadata:
      labels:
        app: registry-query
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 65534
        fsGroup: 65534
        seccompProfile:
          type: RuntimeDefault
      containers:
      - name: registry-tools
        image: docker.io/alpine:latest
        command: ["/bin/sh"]
        args:
          - -c
          - |
            # Install crane and curl
            apk add --no-cache curl
            wget -O /tmp/crane.tar.gz https://github.com/google/go-containerregistry/releases/download/v0.20.2/go-containerregistry_Linux_arm64.tar.gz
            tar -xzf /tmp/crane.tar.gz -C /usr/local/bin crane
            chmod +x /usr/local/bin/crane

            # Keep container running
            while true; do sleep 3600; done
        env:
          - name: REGISTRY
            value: "docker-registry.registry.svc.cluster.local:5000"
        securityContext:
          allowPrivilegeEscalation: false
          runAsNonRoot: true
          runAsUser: 65534
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: false
        volumeMounts:
          - name: docker-config
            mountPath: /root/.docker
            readOnly: true
        resources:
          requests:
            cpu: 10m
            memory: 64Mi
          limits:
            cpu: 100m
            memory: 128Mi
      volumes:
        - name: docker-config
          secret:
            secretName: registry-credentials
            items:
              - key: .dockerconfigjson
                path: config.json
