---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: cloudflared
  namespace: network
spec:
  chart:
    spec:
      chart: cloudflare-tunnel-remote
      version: 0.3.x
      sourceRef:
        kind: HelmRepository
        name: cloudflare
        namespace: flux-system
  interval: 1h
  values:
    # Cloudflare Tunnel configuration
    cloudflare:
      # Tunnel token from cluster-secrets (injected via Flux postBuild substitution)
      tunnel_token: ${CLOUDFLARE_TUNNEL_TOKEN}

    # Replica count for high availability
    replicaCount: 2

    # Resource limits for Raspberry Pi
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 200m
        memory: 128Mi

    # Pod annotations
    podAnnotations:
      prometheus.io/scrape: "true"
      prometheus.io/port: "2000"
      prometheus.io/path: "/metrics"

    # Security context
    podSecurityContext:
      runAsUser: 65532
      runAsGroup: 65532
      fsGroup: 65532
      runAsNonRoot: true

    # Update strategy
    strategy:
      type: RollingUpdate
      rollingUpdate:
        maxUnavailable: 1
        maxSurge: 1
